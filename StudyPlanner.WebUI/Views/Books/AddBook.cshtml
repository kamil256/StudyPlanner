@model StudyPlanner.WebUI.Models.BooksAddBookViewModel

<h1 id="heading" class="heading"></h1>

<input id="bookId" name="bookId" type="hidden" />
<div class="form-group">
    <label for="title">Title</label>
    <input id="title" name="title" class="form-control" />
</div>
<div class="form-group">
    <label for="Author">Authors</label>
    <ul id="authorsList"></ul>
    <input id="Author" class="form-control" list="authorsDataList" onchange="AddAuthor(this.value)" />
    <datalist id="authorsDataList">
        @foreach (var a in Model.AuthorsList)
        {
            <option value="@a.Name"></option>
        }
    </datalist>
    <div id="hiddenAuthors"></div>
</div>
<table>
    <tr>
        <td>
            <div class="form-group">
                <label for="publisher">Publisher</label>
                <input id="publisher" name="publisher" class="form-control" list="publishersDataList" />
                <datalist id="publishersDataList">
                    @foreach (var p in Model.PublishersList)
                    {
                        <option value="@p.Name"></option>
                    }
                </datalist>
            </div>
            <div class="form-group">
                <label for="released">Released</label>
                <input id="released" name="released" type="date" class="form-control" />
            </div>
            <div class="form-group">
                <label for="pages">Pages</label>
                <input id="pages" name="pages" type="number" class="form-control" />
            </div>
        </td>
        <td>
            <label for="cover">Cover</label>
            <div class="form-control">
                <img id="image" src="" class="hidden" />
                <b id="chooseImageMsg">Choose image</b>
                <input id="Cover" name="Cover" type="file" accept="image/*" onclick="cancelCover()" onchange="readURL(this)" />
            </div>
        </td>
    </tr>
</table>                
<button id="submit" type="submit" class="btn btn-default" onclick="sendData()">Ok</button>
<button class="btn btn-default" onclick="$('#add-book-dialog').dialog('close')">Cancel</button>

<script>
    var imageSentToServer = false;

    function sendData()
    {
        var data = new FormData();
        var inputs = document.getElementById("add-book-dialog").getElementsByTagName("input");
        for (var i = 0; i < inputs.length; i++) {
            if (inputs[i].name) {
                if (inputs[i].type == "file")
                {
                    data.append(inputs[i].name, inputs[i].files[0]);
                    imageSentToServer = true;
                }
                else
                    data.append(inputs[i].name, inputs[i].value);
            }
        }
        
        $.ajax({
            url: '@Url.Action("AddBook")',
            cache: false,
            contentType: false,
            processData: false,
            data: data,
            dataType: "json",
            type: 'POST',
            success: function (response) 
            {
                console.log(response);
                if (response.ResponseUrl != null)
                    window.location.href = response.ResponseUrl;
            }
        });
    }
    
    function readURL(input)
    {
        if (input.files && input.files[0])
        {
            var reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById("image").className = "";
                document.getElementById("chooseImageMsg").className = "hidden";
                $('#image').attr('src', e.target.result);
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function cancelCover()
    {
        if (!imageSentToServer)
        {
            document.getElementById("image").className = "hidden";
            document.getElementById("chooseImageMsg").className = "";
        }
    }

    window.onload = function () {
        $("#Author").on("keydown",
            function (e) {
                if ((e.keyCode | e.which) == 13) {
                    e.preventDefault();
                    AddAuthor($("#Author").val());
                }
            });



        
    }













    var authors = [];

    function getAuthorsFromHidden() {
        authors = [];
        var inputAuthors = document.getElementById("hiddenAuthors").getElementsByTagName("input");
        for (var i = 0; i < inputAuthors.length; i++) {
            authors.push(inputAuthors[i].value);
        }
    }

    function createHiddenFromAuthors() {
        var authorsElement = document.getElementById("authorsList");
        authorsElement.innerHTML = "";
        for (var i = 0; i < authors.length; i++)
            authorsElement.innerHTML += "<li>" + authors[i] + "<b onclick='RemoveAuthor(" + i + ")'> &times;</b></li> ";

        var inputAuthors = document.getElementById("hiddenAuthors");
        inputAuthors.innerHTML = "";
        for (var i = 0; i < authors.length; i++)
            inputAuthors.innerHTML += "<input type='hidden' id='Authors_" + i + "_' name='Authors[" + i + "]' value='" + authors[i] + "' />";
    }

    function AddAuthor(name) {
        if ($("#Author").val() != "") {
            getAuthorsFromHidden();
            if (authors.indexOf(name) == -1) {
                authors.push(name);
                createHiddenFromAuthors();
            }
            $("#Author").val("");
        }
    }

    function RemoveAuthor(nr) {
        getAuthorsFromHidden();
        authors.splice(nr, 1);
        createHiddenFromAuthors();
    }
</script>