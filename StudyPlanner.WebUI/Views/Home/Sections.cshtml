@model StudyPlanner.WebUI.Models.SectionsModel

<h1 class="heading">Sections</h1>

@if (Model.Books.Length == 0)
{
    <div class="alert alert-danger">No books were added!</div>
}
else
{
    using (Html.BeginForm("Sections", "Home", FormMethod.Get, new { id = "SelectBookForm" }))
    {
        <div class="form-group">
            @Html.Label("BookId", "Select a book to see its sections: ")
            @Html.DropDownList("BookId", new SelectList(Model.Books, "BookId", "Title", Model.SelectedBook.BookId), new { @class = "form-control" })
        </div>
    }       
              
    <div class="well well book-details">
        <img src="/Covers/@Model.SelectedBook.Cover" width="120" />
        <div>
            <b>@Model.SelectedBook.Title</b>
            @switch (Model.SelectedBookAuthors.Length)
            {
                case 0:
                    @:Author: unknown
                    break;
                case 1:
                    @:Author:
                    break;
                default:
                    @:Authors:
                    break;
            }  
            @for (int i = 0; i < Model.SelectedBookAuthors.Length; i++)
            {
                if (i < Model.SelectedBookAuthors.Length - 1)
                {
                    @Model.SelectedBookAuthors[i]<span>,</span>
                }
                else
                {
                    @Model.SelectedBookAuthors[i]
                }
            }
            <br />
            Publisher: @Model.SelectedBook.Publisher.Name<br />
            Released: @Model.SelectedBook.Released.ToLongDateString()<br />
            Pages: @Model.SelectedBook.Pages
        </div>
    </div>

    using (Html.BeginForm("Sections", "Home", FormMethod.Post, new { autocomplete = "off" }))
    {
        <table class="table sections-table">
            <thead>
                <tr>
                    <th colspan="3">Pages</th>
                    <th>Total pages</th>
                    <th>Section name</th>
                    <th>Trainings completed</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var x in Model.Sections)
                {
                    <tr>
                        <td>@x.StartPageNumber</td>
                        <td>-</td>
                        <td>@x.EndPageNumber</td>
                        <td>@x.NumberOfPages</td>
                        <td>@x.Name</td>
                        <td>@x.NumberOfTrainingsCompleted</td>
                        <td>
                            @if (x.IsTrainingInProgress)
                            {
                                @Html.ActionLink("Go to training", "Trainings", new { FilterBookId = Model.SelectedBook.BookId, FilterSectionId = x.SectionId, FilterTrainingCompleted = false }, new { @class = "btn btn-default btn-xs" })
                            }
                            else
                            {
                                @Html.ActionLink("Start new training", "AddTraining", new { BookId = Model.SelectedBook.BookId, SectionId = x.SectionId }, new { @class = "btn btn-default btn-xs" })
                            }
                        </td>
                    </tr>
                }
                <tr>
                    <td>@Html.TextBoxFor(x => x.NewSectionStartPageNumber, new { type = "number", @class = "form-control", required = "required" })</td>
                    <td>-</td>
                    <td>@Html.TextBoxFor(x => x.NewSectionEndPageNumber, new { type = "number", @class = "form-control", required = "required" })</td>
                    <td id="NewSectionTotalPages">-</td>
                    <td>@Html.TextBoxFor(x => x.NewSectionName, new { @class = "form-control", required = "required" })</td>
                    <td>-</td>
                    <td>
                        <input type="hidden" name="BookId" value="@Model.SelectedBook.BookId" />
                        <input type="submit" value="Add" class="btn btn-default btn-xs" />
                    </td>
                </tr>
            </tbody>
        </table>
    }
}

<script type="text/javascript">
    $(function () {
        $("#BookId").on("change", function () { $("#SelectBookForm").submit() });
    });

    var newSectionStartPageNumber = document.getElementById("NewSectionStartPageNumber");
    var newSectionEndPageNumber = document.getElementById("NewSectionEndPageNumber");
    var newSectionTotalPages = document.getElementById("NewSectionTotalPages");

    newSectionStartPageNumber.onchange = countNewSectionsTotalPages;
    newSectionEndPageNumber.onchange = countNewSectionsTotalPages;

    function countNewSectionsTotalPages()
    {
        if (newSectionStartPageNumber.value && newSectionEndPageNumber.value)
            newSectionTotalPages.innerHTML = newSectionEndPageNumber.value - newSectionStartPageNumber.value + 1;
        else
            newSectionTotalPages.innerHTML = "-";
    };
</script>
